# {{ ansible_managed }}
{% raw %}
- name: Create controller_login fact and anchor
  ansible.builtin.set_fact:
    controller_login: &controller_login
      controller_username: "{{ controller_username | default(omit) }}"
      controller_password: "{{ controller_password | default(omit) }}"
      controller_host: "{{ controller_hostname | default(omit) }}"
      validate_certs: "{{ controller_validate_certs | default(false) }}"
{% endraw %}

- name: Clear previous config exports
  ansible.builtin.file:
    path: "{{ playbook_dir }}/../files/exported/controller_export_output.yml"
    state: absent

{% for object in controller_objects %}
- name: Export controller configuration - {{ object.api_name | default(object.arg_name) }}
  awx.awx.export:
    {{ object.arg_name }}: "[{% raw %}{{{% endraw %} query('awx.awx.controller_api', '{{ object.api_name | default(object.arg_name) }}',
            host=controller_hostname,
            username=controller_username,
            password=controller_password,
            verify_ssl=controller_validate_certs,
            query_params={{ object.query_params | default(default_query_params) }}) | map(attribute='{{ object.field_name | default('name') }}') | map('quote') | join(', ') {% raw %}}}{% endraw %}]"
    <<: *controller_login
  register: __{{ object.arg_name }}_object_results

- name: Write controller config to file - {{ object.api_name | default(object.arg_name) }}
  ansible.builtin.blockinfile:
    path: "{% raw %}{{{% endraw %} playbook_dir {% raw %}}}{% endraw %}/../files/exported/controller_export_output.yml"
    mode: 0644
    state: present
    create: true
    marker: "# {mark} {{ object.api_name | default(object.arg_name) }}"
    block: "{% raw %}{{{% endraw %} __{{ object.arg_name }}_object_results.assets | ansible.utils.remove_keys(target=['natural_key']) |
        to_nice_yaml(indent=2, width=50) |
        regex_replace('{{ object.api_name | default(object.arg_name) }}:','controller_{{ object.api_name | default(object.arg_name) }}:') {% raw %}}}{% endraw %}"

{% endfor %}
